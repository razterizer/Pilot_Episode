name: release windows

on:
  push:
    tags:
      - 'release-*'
      - 'v*'

jobs:
  build-windows-release:
    runs-on: windows-latest
  
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Move to the parent directory and fetch dependencies
      - name: Fetch dependencies
        run: |
          cd ..
          mkdir lib
          cd lib
          git clone https://github.com/razterizer/Core.git
          git clone https://github.com/razterizer/Termin8or.git
          git clone https://github.com/razterizer/8Beat.git
          git clone https://github.com/razterizer/AudioLibSwitcher_applaudio.git --recurse-submodules
          git clone https://github.com/razterizer/applaudio.git
          git clone https://github.com/razterizer/TrainOfThought.git

      # Step 3: Build project
      - name: Run build.bat
        continue-on-error: false
        run: |
          cd $env:GITHUB_WORKSPACE\Pilot_Episode
          ./build.bat
          
      - name: Debug - List ALL files after build
        run: |
          cd $env:GITHUB_WORKSPACE
          echo "=== Full directory structure ==="
          Get-ChildItem -Recurse -File | Select-Object Name, Directory | Format-Table
          
      - name: Prepare files for upload
        run: |
          New-Item -ItemType Directory -Force -Path "upload-temp"
          Copy-Item "Pilot_Episode/x64/Release/Pilot_Episode.exe" "upload-temp/"
          Copy-Item "Pilot_Episode/x64/Release/chiptune2.ct" "upload-temp/"
          if (Test-Path "Pilot_Episode/x64/Release/fonts") {
              Copy-Item -Recurse "Pilot_Episode/x64/Release/fonts" "upload-temp/"
          }

      # Step 4: Upload build artifact
      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pilot_episode-windows-build
          path: upload-temp/
          retention-days: 1

  create-windows-release:
    runs-on: windows-latest
    needs: build-windows-release
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Windows build artifact
        uses: actions/download-artifact@v4
        with:
          name: pilot_episode-windows-build
          path: windows-build
          
      - name: Debug - List downloaded files
        run: |
          cd windows-build
          echo "=== Downloaded files ==="
          Get-ChildItem -Recurse
          
      - name: Create Windows distribution package
        run: |
          cd windows-build
          # Create a clean distribution folder
          New-Item -ItemType Directory -Force -Path "pilot_episode-${{ github.ref_name }}"
          # Copy the executable and necessary files
          Copy-Item "Pilot_Episode.exe" "pilot_episode-${{ github.ref_name }}/"
          Copy-Item "chiptune2.ct" "pilot_episode-${{ github.ref_name }}/"
          # Copy fonts directory (if it exists)
          if (Test-Path "fonts") {
            Copy-Item -Recurse "fonts" "pilot_episode-${{ github.ref_name }}/"
          }
          echo "Unblock instructions:" > pilot_episode-${{ github.ref_name }}/README.txt
          echo "=====================" >> pilot_episode-${{ github.ref_name }}/README.txt
          echo "To tell Windows that this executable is fine" >> pilot_episode-${{ github.ref_name }}/README.txt
          echo " you can unblock the executable by" >> pilot_episode-${{ github.ref_name }}/README.txt
          echo " rightclicking the exe, then:" >> pilot_episode-${{ github.ref_name }}/README.txt
          echo "   Properties -> Unblock (check this)." >> pilot_episode-${{ github.ref_name }}/README.txt
          # Create zip archive
          Compress-Archive -Path "pilot_episode-${{ github.ref_name }}" -DestinationPath "pilot_episode-${{ github.ref_name }}-windows.zip"
          
      - name: Upload Windows package to release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}  # Note: just the tag name, not refs/tags/
          artifacts: windows-build/pilot_episode-${{ github.ref_name }}-windows.zip
          allowUpdates: true  # ‚Üê This is the key!
          body: ${{ github.event.release.body || github.event.head_commit.message }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

